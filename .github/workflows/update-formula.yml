name: Update Formula

on:
  repository_dispatch:
    types: [update-formula]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (e.g., 0.1.0)'
        required: true
        type: string

jobs:
  update-formula:
    runs-on: macos-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          else
            VERSION="${{ inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Updating formula to version $VERSION"

      - name: Wait for PyPI release
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "Waiting for PyPI release of patterndb-yaml $VERSION..."
          MAX_ATTEMPTS=60  # 10 minutes (60 * 10 seconds)
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -sf "https://pypi.org/pypi/patterndb-yaml/$VERSION/json" > /dev/null; then
              echo "✅ Package found on PyPI!"
              break
            fi
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Package not yet available, waiting..."
            sleep 10
          done

          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "❌ Timeout: Package not found on PyPI after 10 minutes"
            exit 1
          fi

      - name: Get package info from PyPI
        id: pypi
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          echo "Fetching package info from PyPI..."
          PYPI_JSON=$(curl -s "https://pypi.org/pypi/patterndb-yaml/$VERSION/json")

          # Get the sdist (source distribution) URL and SHA256
          URL=$(echo "$PYPI_JSON" | jq -r '.urls[] | select(.packagetype=="sdist") | .url')
          SHA256=$(echo "$PYPI_JSON" | jq -r '.urls[] | select(.packagetype=="sdist") | .digests.sha256')

          if [ -z "$URL" ] || [ -z "$SHA256" ]; then
            echo "❌ Failed to get package URL or SHA256 from PyPI"
            exit 1
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Package URL: $URL"
          echo "Package SHA256: $SHA256"

      - name: Update formula
        env:
          VERSION: ${{ steps.version.outputs.version }}
          URL: ${{ steps.pypi.outputs.url }}
          SHA256: ${{ steps.pypi.outputs.sha256 }}
        run: |
          FORMULA_FILE="Formula/patterndb-yaml.rb"

          # Update ONLY the first url line (the main package, not resources)
          sed -i '' '0,/^  url ".*"/s||  url "'"$URL"'"|' "$FORMULA_FILE"

          # Update ONLY the first sha256 line (the main package, not resources)
          sed -i '' '0,/^  sha256 ".*"/s||  sha256 "'"$SHA256"'"|' "$FORMULA_FILE"

          # Update version in test block if it contains version check
          sed -i '' "s|patterndb-yaml version .*|patterndb-yaml version|" "$FORMULA_FILE"

          echo "Formula updated successfully"
          git diff "$FORMULA_FILE"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: Update patterndb-yaml to v${{ steps.version.outputs.version }}"
          branch: "update-formula-v${{ steps.version.outputs.version }}"
          delete-branch: true
          title: "Update patterndb-yaml to v${{ steps.version.outputs.version }}"
          body: |
            ## Update patterndb-yaml formula

            This PR updates the Homebrew formula to version **${{ steps.version.outputs.version }}**.

            ### Changes
            - **Version**: ${{ steps.version.outputs.version }}
            - **URL**: ${{ steps.pypi.outputs.url }}
            - **SHA256**: `${{ steps.pypi.outputs.sha256 }}`

            ### PyPI Release
            https://pypi.org/project/patterndb-yaml/${{ steps.version.outputs.version }}/

            ### Automated Update
            This PR was automatically created by the [update-formula workflow](.github/workflows/update-formula.yml).

            ### Testing
            To test this update locally:
            ```bash
            brew install --build-from-source jeffreyurban/patterndb-yaml/patterndb-yaml
            brew test patterndb-yaml
            ```

            ---

            **Triggered by**: ${{ github.event_name == 'repository_dispatch' && 'Release in main repository' || 'Manual workflow dispatch' }}
          labels: |
            automated
            formula-update
